<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Task 3: Write a JavaScript function that finds how many times a substring is contained in a given text (perform case insensitive search).</title>
    <link href="styles/js-console.css" rel="stylesheet" />
</head>
<body>
    <div>Task 3: Write a JavaScript function that finds how many times a substring is contained in a given text (perform case insensitive search).</div>
    <label for="tb-text">Text: </label>
    <input type="text" name="tb-text" id="tb-text" />
    <label for="tb-search">String to search and count: </label>
    <input type="text" name="tb-search" id="tb-search" />
    <a href="#" id="btn-check-prime" onclick="onBtnClick()">Search</a>
    <div id="js-console">
    </div>
    <script src="script/js-console.js"></script>
    <script>

        
        function onBtnClick() {
            var res = parseString("We are <mixcase>living</mixcase> in a <upcase>yellow submarine</upcase>. We <mixcase>don't</mixcase> have <lowcase>anything</lowcase> else.");
            
            jsConsole.write(res);
     
        }

        function parseString(source){
            var tempStack = [];
            var finalStack = [];
            var tags = {};
            var startIndex = 0; // current position of "<" tags
            var endIndex = 0; // current position of ">" tags
            var patterns = ["<upcase>","</upcase>","<lowcase>","</lowcase>","<mixcase>","</mixcase>"];
            var extract = ""; // current extracted tag
            var startPosition = 0;
            var target ="";
            console.log(source);
            while(true){
                startIndex = source.indexOf("<", startPosition++);
                console.log(startIndex);

                if (startIndex < 0) {
                    break;
                }
                else
                {
                    endIndex = source.indexOf(">", startPosition);
                    console.log(endIndex);

                    if (endIndex < 0) {
                        break;
                    }
                    extract = source.substr(startIndex, endIndex-startIndex);
                    if(extract === patterns[0] || extract === patterns[1] || extract === patterns[2] ||extract === patterns[3]||extract === patterns[4] || extract === patterns[5] ){
                        target+=source.slice(startPosition, startIndex-startPosition);
                        startPosition = startIndex;
                        if (extract.charAt(1) !== "/") {
                            // starting tag
                            var opentag = {};
                            opentag.start = startIndex;
                            opentag.type = extract;
                            tempStack.push(opentag);
                        }
                        else{
                            // closing tag
                            var node = tempStack.pop();
                            node.end = endIndex-node.type.length;
                            finalStack.push(node);
                        }
                    }
                }
                
            }
            return target;
        }

        String.prototype.toMix() = function(){
            // TODO: mixing case
        }


        var text = "We are <mixcase>living</mixcase> in a <upcase>yellow submarine</upcase>. We <mixcase>don't</mixcase> have <lowcase>anything</lowcase> else." +
     "Inside <upcase>the submarine <lowcase>is very</lowcase> tight</upcase>. <mixcase>So we are <upcase>drinking</upcase> all the day.</mixcase> We will move out of it in 5 days."

        //var mixedcase = ["<mixcase>", "</mixcase>"];
        //var upcase = ["<upcase>", "</upcase>"];
        //var lowcase = ["<lowcase>", "</lowcase>"];

        var tagStack = TagStack();
        var stringBuilder = buildStringBuilder();

        for (var i = 0; i < text.length; i++) {
            if (text[i] == "<") {
                var closing = "", len = 0;
                while (closing != ">") {
                    len++;
                    closing = text[i + len];
                }
                tagStack.add(text.substr(i + 1, len - 1));
                i += len;
            }
            else {
                switch (tagStack.peek().toString()) {
                    case "upcase": stringBuilder.append(text[i].toUpperCase()); break;
                    case "lowcase": stringBuilder.append(text[i].toLowerCase()); break;
                    case "mixcase":
                        {
                            if ((i & 1) == 0) stringBuilder.append(text[i].toUpperCase());
                            else stringBuilder.append(text[i].toLowerCase());
                        }
                        break;
                    case "none": stringBuilder.append(text[i]); break;
                }
            }


        }

        jsConsole.writeLine(stringBuilder.toString());

        function TagStack() {
            return {
                stack: new Array(),
                len: 0,
                add: function (tag) {
                    tag = new String(tag);
                    if (this.isOpening(tag)) {
                        this.stack.push(tag);
                        this.len++;
                    }
                    else {
                        var madeOpening = tag.substr(1, tag.length - 1);
                        if (this.peek() == madeOpening) {
                            this.stack.pop();
                            this.len--;
                        }
                    }
                },
                isOpening: function (tag) {
                    tag = new String(tag);
                    if (tag[0] == "/")
                        return false;
                    else
                        return true;
                },
                peek: function () {
                    if (this.len == 0) return "none";
                    return this.stack[this.len - 1];
                }
            }
        }

    </script>
</body>
</html>

